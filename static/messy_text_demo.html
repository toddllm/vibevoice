<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeVoice - Messy Text Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-section textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .example-buttons {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .example-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .example-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .output-section {
            position: relative;
        }
        
        .normalized-text {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        
        .status-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }
        
        .status-badge.active {
            display: block;
        }
        
        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .control-group select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .process-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-left: auto;
        }
        
        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .audio-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
        }
        
        .audio-section.active {
            display: block;
        }
        
        .audio-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .process-btn {
                width: 100%;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé≠ VibeVoice Messy Text Demo</h1>
            <p class="subtitle">Test arbitrary text formats - we'll normalize them for you!</p>
        </header>
        
        <div class="main-grid">
            <div class="card input-section">
                <h2>
                    <span>üìù</span>
                    <span>Input Text</span>
                </h2>
                <textarea id="inputText" placeholder="Enter any text format:
- Named speakers (Alice: Hello)
- Numbered speakers (Speaker 1: Hi)
- Informal dialogue (Bob says 'hi')
- Mixed formats
- Bullets, quotes, stage directions..."></textarea>
                
                <div class="example-buttons">
                    <button class="example-btn" onclick="loadExample('dialogue')">üìñ Dialogue</button>
                    <button class="example-btn" onclick="loadExample('script')">üé¨ Script</button>
                    <button class="example-btn" onclick="loadExample('narrative')">üìö Narrative</button>
                    <button class="example-btn" onclick="loadExample('mixed')">üîÄ Mixed</button>
                    <button class="example-btn" onclick="loadExample('messy')">üå™Ô∏è Messy</button>
                    <button class="example-btn" onclick="loadExample('long')">üìú Long Story</button>
                </div>
            </div>
            
            <div class="card output-section">
                <h2>
                    <span>‚ú®</span>
                    <span>Normalized Output</span>
                </h2>
                <div class="status-badge" id="statusBadge">Normalized</div>
                <div class="normalized-text" id="normalizedText">Normalized text will appear here...</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Model</label>
                <select id="modelSelect">
                    <option value="7B">7B (Best Quality)</option>
                    <option value="1.5B">1.5B (Faster)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Voice</label>
                <select id="voiceSelect">
                    <option value="en-Alice_woman">Alice (Woman)</option>
                    <option value="en-Emily_woman">Emily (Woman)</option>
                    <option value="en-Frank_man">Frank (Man)</option>
                    <option value="en-Carter_man">Carter (Man)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Max Duration</label>
                <select id="durationSelect">
                    <option value="30">30 seconds</option>
                    <option value="60">1 minute</option>
                    <option value="120">2 minutes</option>
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                    <option value="0" selected>No limit (Model Max)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="process-btn" id="normalizeBtn" onclick="normalizeText()">
                    üìù Normalize Text
                </button>
                <button class="process-btn" id="synthesizeBtn" onclick="synthesizeNormalized()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    üé§ Synthesize
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">Processing your text...</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="audio-section" id="audioSection">
            <h3>üîä Generated Audio</h3>
            <audio id="audioPlayer" controls></audio>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="speakerCount">0</div>
                    <div class="stat-label">Speakers Detected</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="audioDuration">0s</div>
                    <div class="stat-label">Audio Duration</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="processingTime">0s</div>
                    <div class="stat-label">Processing Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="rtfValue">0x</div>
                    <div class="stat-label">RTF Speed</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const examples = {
            dialogue: `Alice: Welcome everyone to today's meeting!
Bob: Thanks for having me, Alice.
Alice: Let's start with the quarterly report.
Bob: I've prepared some slides to share.
(pause)
Alice: Excellent, please go ahead.`,
            
            script: `INT. COFFEE SHOP - DAY

- Alice enters the bustling coffee shop
- Bob waves from a corner table

Bob says "Over here!"
Alice responds with "Sorry I'm late"

They sit down to discuss the project...`,
            
            narrative: `Alice welcomes everyone to the presentation.
Bob thanks her for the opportunity.
"This is exciting," Alice mentions.
Bob agrees and starts his presentation.
The audience listens intently.`,
            
            mixed: `Speaker 1: Let's begin the demo
Alice: I'll go first
- Bob: Great idea!
Speaker 2: Count me in
‚Ä¢ Charlie says "Me too!"
[Everyone laughs]
They continue the discussion...`,
            
            messy: `- AliceÔºö Welcome! ‰ªäÂ§©ÂæàÈ´òÂÖ¥ËßÅÂà∞Â§ßÂÆ∂
    Bob says "Thanks for having me"
    (pause for effect)
Speaker 3: I'm new here
‚Ä¢ Dave responds quickly: "Welcome aboard!"
    ... silence ...
Alice: Let's check https://example.com for more info
Everyone: Agreed!`,

            long: `Chapter 1: The Meeting

Alice entered the conference room with confidence. The morning sun streamed through the large windows, casting long shadows across the polished table.

"Good morning, everyone," Alice began. "Thank you all for coming on such short notice."

Bob looked up from his laptop. "No problem at all. This project is important to all of us."

Charlie nodded in agreement. "Absolutely. We've been waiting for this opportunity."

Alice: Let me start by sharing our vision for the next quarter. We've identified three key areas where we can make significant improvements.

Bob interjects: That sounds ambitious. What's our timeline?

"We have twelve weeks," Alice responded. "It's aggressive, but I believe we can do it."

[There's a moment of silence as everyone processes this information]

Charlie says thoughtfully, "I think we should break this down into smaller milestones."

- Alice: Excellent point
- Bob agrees: Yes, that makes sense
- Dave (joining late): Sorry I'm late! What did I miss?

Alice quickly brings Dave up to speed...

Speaker 5: Welcome, Dave. We were just discussing the project timeline.

The team continues their discussion for the next hour. Ideas flow freely, with each member contributing their unique perspective.

Bob mentions, "We should consider the technical challenges."
Charlie adds her thoughts about resource allocation.
Dave brings up budget concerns.

As the meeting progresses, Alice takes detailed notes. She knows this is just the beginning of a long journey.

"Before we wrap up," Alice says, pausing for effect, "I want each of you to know how much I value your contribution to this team."

The room fills with a sense of purpose and determination. Everyone knows the road ahead won't be easy, but they're ready for the challenge.

Bob: I'll start working on the technical specifications immediately.
Charlie: And I'll draft the project plan.
Dave: I'll handle the budget projections.

Alice smiles. "Perfect. Let's reconvene tomorrow at the same time."

As everyone gathers their belongings and prepares to leave, there's an energy in the air - the kind that comes from a team united in purpose.

(End of Chapter 1)

Chapter 2: The Challenge

The next day arrived faster than expected. Alice had spent most of the night reviewing proposals and refining the strategy.

"Morning, team," she greeted as people filed in.

Bob looked tired. "Long night?"

Alice nodded. "You could say that. But I think you'll like what I've come up with."

She began presenting the refined plan, with detailed charts and projections filling the screen.

Charlie interrupts: These numbers seem optimistic.

"They are," Alice admitted, "but not unrealistic. Here's why..."

The discussion continues, with each team member raising concerns and offering solutions. This is what makes them effective - the ability to challenge ideas while remaining supportive.

[Several hours pass]

Finally, they reach consensus. The plan is ambitious but achievable. Everyone has their assignments, and the real work begins.

Dave summarizes: So we're all clear on next steps?

Everyone nods in agreement.

Alice: Then let's make it happen.

The team disperses, each member carrying a piece of the larger puzzle. The success of the project now depends on their ability to execute individually while staying connected as a team.

Bob thinks to himself, "This is going to be interesting."

Charlie feels a mix of excitement and apprehension.

Dave is already calculating resource requirements.

And Alice? She's already thinking three steps ahead, anticipating challenges and preparing solutions.

The journey has truly begun...`
        };
        
        function loadExample(type) {
            document.getElementById('inputText').value = examples[type];
            // Clear previous results when loading new example
            document.getElementById('normalizedText').textContent = 'Click "Normalize" to process this text...';
            document.getElementById('statusBadge').textContent = 'Ready';
            document.getElementById('statusBadge').classList.remove('active');
        }
        
        async function normalizeText() {
            const text = document.getElementById('inputText').value;
            if (!text.trim()) return;
            
            const normalizedDiv = document.getElementById('normalizedText');
            const statusBadge = document.getElementById('statusBadge');
            
            // Reset UI
            normalizedDiv.textContent = 'Processing...';
            statusBadge.textContent = 'Processing';
            statusBadge.classList.remove('active');
            
            try {
                // Use streaming endpoint for real-time updates
                const response = await fetch('/normalize/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'status') {
                                    statusBadge.textContent = data.message;
                                    normalizedDiv.textContent = data.message;
                                    console.log('[VibeVoice] Status:', data.message);
                                } else if (data.type === 'progress') {
                                    statusBadge.textContent = data.message;
                                    console.log('[VibeVoice] Progress:', data.message);
                                } else if (data.type === 'debug') {
                                    console.log('[VibeVoice] Debug:', data.message);
                                } else if (data.type === 'result') {
                                    normalizedDiv.textContent = data.normalized;
                                    statusBadge.textContent = `${data.units} units`;
                                    statusBadge.classList.add('active');
                                    console.log('[VibeVoice] Result:', {
                                        units: data.units,
                                        processing_time: data.processing_time,
                                        preview: data.normalized.substring(0, 200)
                                    });
                                } else if (data.type === 'complete') {
                                    statusBadge.textContent = 'Complete';
                                    console.log('[VibeVoice] Processing complete');
                                } else if (data.type === 'error') {
                                    normalizedDiv.textContent = `Error: ${data.message}`;
                                    statusBadge.textContent = 'Error';
                                    console.error('[VibeVoice] Error:', data.message, data.error_type || 'unknown');
                                }
                            } catch (e) {
                                // Ignore invalid JSON chunks
                            }
                        }
                    }
                }
                
                setTimeout(() => {
                    document.getElementById('statusBadge').classList.remove('active');
                }, 2000);
            } catch (error) {
                console.error('Normalization error:', error);
            }
        }
        
        async function synthesizeNormalized() {
            const normalizedText = document.getElementById('normalizedText').textContent;
            if (!normalizedText || normalizedText.includes('Click "Normalize"') || normalizedText.includes('Processing')) {
                showError('Please normalize text first before synthesizing!');
                return;
            }
            
            const btn = document.getElementById('synthesizeBtn');
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('errorMessage');
            const audioSection = document.getElementById('audioSection');
            
            btn.disabled = true;
            loading.classList.add('active');
            errorMsg.classList.remove('active');
            audioSection.classList.remove('active');
            
            const startTime = Date.now();
            
            try {
                // Use the already normalized text for synthesis
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: normalizedText,
                        model: document.getElementById('modelSelect').value,
                        voice: document.getElementById('voiceSelect').value,
                        max_seconds: parseInt(document.getElementById('durationSelect').value),
                        format: 'base64'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display audio
                const audio = document.getElementById('audioPlayer');
                audio.src = 'data:audio/wav;base64,' + data.audio;
                
                // Update stats
                const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('audioDuration').textContent = 
                    (data.duration || 0).toFixed(1) + 's';
                document.getElementById('processingTime').textContent = 
                    processingTime + 's';
                document.getElementById('rtfValue').textContent = 
                    (data.rtf || 0).toFixed(2) + 'x';
                
                // Show audio section
                audioSection.classList.add('active');
                
            } catch (error) {
                showError(error.message);
                console.error('Synthesis error:', error);
            } finally {
                btn.disabled = false;
                loading.classList.remove('active');
            }
        }
        
        // Legacy function for backward compatibility 
        async function processText() {
            await synthesizeNormalized();
        }
        
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = '‚ùå ' + message;
            errorMsg.classList.add('active');
            setTimeout(() => {
                errorMsg.classList.remove('active');
            }, 5000);
        }
        
        // Clear status when input changes (no auto-normalize)
        document.getElementById('inputText').addEventListener('input', () => {
            const statusBadge = document.getElementById('statusBadge');
            const normalizedDiv = document.getElementById('normalizedText');
            
            if (statusBadge.textContent !== 'Ready') {
                statusBadge.textContent = 'Ready';
                statusBadge.classList.remove('active');
                normalizedDiv.textContent = 'Click "Normalize" to process this text...';
            }
        });
        
        // Load initial example
        window.addEventListener('DOMContentLoaded', () => {
            loadExample('dialogue');
        });
    </script>
</body>
</html>